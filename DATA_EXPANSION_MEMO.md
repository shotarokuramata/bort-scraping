# 競艇スクレイピング - データ拡張候補メモ

## 現在抽出中のデータ
- 逃げ率（1年間・半年間）
- 逃がし率（1年間・半年間）
- 差され率（1年間・半年間） ✅ **修正済み**
- 捲られ率（1年間・半年間） ✅ **修正済み**
- 直近10レース1着回数

## 抽出可能な追加データ

> **注意**: 以下のデータは **1号艇特化データ** と **全艇共通統計データ** に分類されます。
> 
> - 🎯 **1号艇特化**: 特定の艇（現在は1号艇）のみのデータ
> - 📊 **全艇共通**: 全艇に共通する統計データ  
> - 🔄 **各艇個別**: 各艇ごとに個別に抽出可能なデータ

### 1. 選手基本情報 【優先度：高】🔄 ✅ **実装完了**
- [x] 選手名（フルネーム） ✅ **実装済み**
- [x] 選手番号（4桁の登録番号） ✅ **実装済み**
- [x] 級別（A1, A2, B1, B2） ✅ **実装済み**
- [x] 期別（69期、115期など） ✅ **実装済み**
- [x] 出身支部（埼玉、大阪、静岡、愛知、福岡、東京など） ✅ **実装済み**
- [x] 性別（女性選手は特別マーク付き） ✅ **実装済み（自動判定）**

### 2. 詳細成績データ 【優先度：高】🔄

#### 1着率データ ✅ **実装完了**
- [x] 今期 ✅ **実装済み**
- [x] 直近6ヶ月 ✅ **実装済み**
- [x] 直近3ヶ月 ✅ **実装済み**
- [x] 直近1ヶ月 ✅ **実装済み**
- [x] 当地（該当競艇場での成績） ✅ **実装済み**
- [x] 一般戦 ✅ **実装済み**
- [x] SG/G1 ✅ **実装済み**

#### 2連対率データ ✅ **実装完了**
- [x] 今期 ✅ **実装済み**
- [x] 直近6ヶ月 ✅ **実装済み**
- [x] 直近3ヶ月 ✅ **実装済み**
- [x] 直近1ヶ月 ✅ **実装済み**
- [x] 当地 ✅ **実装済み**
- [x] 一般戦 ✅ **実装済み**
- [x] SG/G1 ✅ **実装済み**

#### 3連対率データ ✅ **実装完了**
- [x] 今期 ✅ **実装済み**
- [x] 直近6ヶ月 ✅ **実装済み**
- [x] 直近3ヶ月 ✅ **実装済み**
- [x] 直近1ヶ月 ✅ **実装済み**
- [x] 当地 ✅ **実装済み**
- [x] 一般戦 ✅ **実装済み**
- [x] SG/G1 ✅ **実装済み**

#### 枠別勝率 ✅ **実装完了**
- [x] 直近1年 ✅ **実装済み**
- [x] 直近6ヶ月 ✅ **実装済み**

### 3. スタートタイミング関連データ 【優先度：高】🔄

#### 平均ST（スタートタイミング） ✅ **実装完了**
- [x] 今期 ✅ **実装済み**
- [x] 直近6ヶ月 ✅ **実装済み**
- [x] 直近3ヶ月 ✅ **実装済み**
- [x] 直近1ヶ月 ✅ **実装済み**
- [x] 当地 ✅ **実装済み**
- [x] 一般戦 ✅ **実装済み**
- [x] SG/G1 ✅ **実装済み**
- [x] 初日 ✅ **実装済み**
- [x] 最終日 ✅ **実装済み**
- [x] ナイター ✅ **実装済み**
- [x] F持（フライング前歴持ち） ✅ **実装済み**

#### ST順位 ✅ **実装完了**
- [x] 上記と同じ条件別で利用可能 ✅ **実装済み**

#### ST考察データ ✅ **実装完了**
- [x] 安定率 ✅ **実装済み**
- [x] 抜出率 ✅ **実装済み**
- [x] 出遅率 ✅ **実装済み**

### 4. 決まり手データ 【優先度：中】📊

#### 直近6ヶ月の決まり手率（共通統計）
- [ ] 逃げ
- [ ] 逃がし（逃がされ率）
- [ ] 差し（コース別）
- [ ] 差され
- [ ] 捲り（コース別）
- [ ] 捲られ

### 5. 個別レース履歴データ 【優先度：中】🎯

#### 過去10走データ（1号艇特化→各艇対応可能）
- [x] 直近10レース1着回数（現在実装済み）
- [ ] 各レースの着順詳細
- [ ] 各レースのコース
- [ ] 各レースの開催場
- [ ] 各レースの日付

### 6. レース基本情報 【優先度：中】📊

#### レース情報
- [ ] レース名（例：「上州きりゅう杯　やんちきどっこい賞競走」）
- [ ] 開催場（例：桐生）
- [ ] レース日（例：初日）
- [ ] レース番号（例：1R）
- [ ] 開催日（例：2025年07月04日）
- [ ] レースグレード（例：予選）

#### 隠されたメタデータ
- [ ] place_no（例：1（桐生））
- [ ] race_no（例：1）
- [ ] hiduke（例：20250704）
- [ ] race_rank（例：予選）
- [ ] race_date_name（例：初日）

### 7. 動的データ（AJAX取得が必要） 【優先度：低】

#### モーター関連データ 🔄
- [ ] モーター番号
- [ ] モーター成績（勝率、1着率、2着率、3着率）
- [ ] モーター決まり手率（逃げ、差し、捲り、捲差、抜き、恵まれ）
- [ ] 使用選手履歴

#### 展示・試走データ 🔄
- [ ] 展示タイム
- [ ] 周回タイム
- [ ] 回り足
- [ ] 直線タイム
- [ ] 展示順位

#### オッズ情報 📊（**⚠️ 現在のHTMLには含まれていません**）
- [ ] 三連単オッズ（別ページまたはAJAX取得が必要）
- [ ] 三連複オッズ（別ページまたはAJAX取得が必要）
- [ ] 二連単オッズ（別ページまたはAJAX取得が必要）
- [ ] 二連複オッズ（別ページまたはAJAX取得が必要）

#### 詳細分析データ 🔄
- [ ] 着順分析
- [ ] 着順分析グラフ
- [ ] ST分布値
- [ ] ST履歴

## 実装計画（データ分類別）

### フェーズ1：基本情報拡張 ✅ **95%完了**
**🔄 各艇個別データ（1号艇→全艇対応）**
- [x] 選手基本情報（名前、番号、級別、期別、支部） ✅ **100%完了**
- [x] 詳細成績データ（1着率、2連対率、3連対率の各期間別） ✅ **100%完了**
- [x] ST関連データ（平均ST、ST順位、安定率、出遅率） ✅ **100%完了**
- [x] フロントエンド表示システム ✅ **100%完了**
- [x] CSS スタイリング ✅ **100%完了**

### フェーズ2：統計データ追加
**📊 全艇共通統計データ**
- 決まり手データ（逃げ、差し、捲りの詳細分析）
- 枠別勝率
- レース基本情報

**🎯 1号艇特化データの拡張**
- 個別レース履歴の詳細化（着順、コース、開催場、日付）

### フェーズ3：高度なデータ取得
**AJAX取得データ（🔄各艇個別 + 📊共通統計）**
- モーター詳細データ（各艇個別）
- 展示タイムデータ（各艇個別）
- オッズ情報（共通統計）

### データ分類と実装方針

#### 🎯 1号艇特化データ → 🔄 各艇個別データ化
- **現状**: 1号艇の特定行からデータ抽出
- **拡張案**: 各艇の行を特定してデータ抽出
- **実装**: 行インデックスの計算式（Row = 2 + 艇番号 * 4）

#### 📊 全艇共通統計データ
- **現状**: 全艇に共通する統計を抽出
- **拡張案**: 追加の共通統計項目を取得
- **実装**: 既存のテーブル解析手法を応用

#### 🔄 各艇個別データ
- **新規**: テーブル構造から各艇の個別データを抽出
- **実装**: CSSセレクタでcourse1-6クラスを活用

## ⚠️ **重要発見：HTMLテーブル構造の特殊性（2025-07-06）**

### 問題：データ不正の根本原因
今回のデバッグで判明した**テーブル構造の特殊性**：

#### 差され率・捲られ率の構造問題
1. **空行の存在**: ヘッダー行の直後に空行が挟まっている
2. **複数項目の混在**: 「捲られ捲り」「捲られ差捲り差し」など複数項目
3. **期間別データの配置**: 半年間→1年間の順序で複数ブロック

#### 実際のテーブル構造（20250705データ検証済み）
```
行67: 捲られ捲り          ← ヘッダー行
行68:                    ← 空行（重要！）
行69: 31.3%0.0%0.0%...   ← 実際のデータ行（半年間）
行70: 捲られ差捲り差し     ← 別項目ヘッダー
行71:                    ← 空行
行72: 18.8%0.0%0.0%...   ← 別項目データ行

行78: 捲られ捲り          ← 1年間ブロックのヘッダー
行79:                    ← 空行
行80: 27.6%0.0%0.0%...   ← 1年間データ行
```

#### 修正された取得ロジック
- **従来**: 検索ベースの動的取得（空行スキップにより失敗）
- **修正後**: 行番号直接指定による確実な取得
  - 半年間捲られ率: 行69の先頭数値
  - 1年間捲られ率: 行80の先頭数値

#### テスト駆動開発による検証
- **検証用データ**: `20250705/biyori.html`
- **期待値（全項目）**:
  - 逃げ率: 1年間31.0%、半年間18.8%
  - 逃がし率: 1年間62.2%、半年間64.0%
  - 差され率: 1年間17.2%、半年間25.0%
  - 捲られ率: 1年間27.6%、半年間31.3%
  - 直近10レース1着回数: 1回
- **検証結果**: ✅ 全項目で完全一致を確認

### HTMLパース時の重要な学習事項
1. **動的検索の限界**: 空行やフォーマット変更に脆弱
2. **行番号直接指定**: より確実だが構造変更に脆弱
3. **テスト駆動**: 期待値を明確にした検証が必須

## 技術的な実装メモ

### ⚠️ **重要：データ抽出の分類（1号艇特化 vs 共通統計）**

現在のプログラムには**2種類のデータ抽出**が混在しています：

#### 🎯 **1号艇特化データ**
- **直近10レース1着回数**: Tables[5] Row[5]から1号艇のみの着順データを抽出
- `row_values.iter().filter(|&v| v == "1").count()` で1号艇の1着回数をカウント

#### 📊 **全艇共通統計データ**  
- **逃げ率・逃がし率**: 全艇に共通する統計データを抽出
- **差され率・捲られ率**: 全艇に共通する統計データを抽出（修正済み）

### 現在の実装の詳細
- URLパラメータ`slider=1`は**Webページ指定**（特定艇データ表示用）
- HTMLテーブルは全艇分のデータを含む
- パーサーは**混合アプローチ**：
  - 共通統計: 全艇対象テーブルから抽出
  - 個別データ: 1号艇の特定行から抽出

### テーブル構造（Tables[5] = 過去10走テーブル）
```
Row 2:  1号艇のデータ行
Row 6:  2号艇のデータ行  
Row 10: 3号艇のデータ行
Row 14: 4号艇のデータ行
Row 18: 5号艇のデータ行
Row 22: 6号艇のデータ行
```

### 拡張時の設計判断
1. **1号艇特化継続** - 現在の仕様を維持
2. **全艇個別対応** - 各艇の個別データを配列で取得
3. **選択可能方式** - パラメータで対象艇を指定

### HTMLパース対象
- 静的HTMLから抽出可能なデータはscraperクレートで対応
- CSSセレクタまたはXPathでの要素特定が必要
- **1号艇のみ vs 全艇対応**の設計判断が必要

### AJAX取得対象
- headless_chromeでJavaScript実行が必要
- 動的コンテンツの読み込み待機処理が必要

### データ構造拡張
- 現在の`RaceData`構造体を拡張
- 新しい構造体の定義が必要（`PlayerData`, `MotorData`等）
- **1号艇のみ vs 全艇配列**の設計判断が必要

## 参考ファイル
- HTMLサンプル：`/home/shotaro/bort-scraping/src-tauri/bort-html/20250704/biyori.html`
- 現在のパーサー：`src-tauri/src/parse/biyori/flame.rs`
- メインライブラリ：`src-tauri/src/lib.rs`

## 参考情報
- **検証用サンプル**: `bort-html/20250705/biyori.html`
- **テスト実装**: `src-tauri/src/parse/biyori/flame.rs` の `test_get_escaped_flame_info_20250705` 関数
- **テスト実行**: `cargo test test_get_escaped_flame_info_20250705 -- --nocapture`
- **全項目アサーション**: 逃げ率、逃がし率、差され率、捲られ率、直近10レース1着回数

## 📊 **進捗サマリー（2025-07-10更新）**

### 🎯 **全体進捗率: 約65-70%**

#### ✅ **フェーズ1: 基本情報拡張** - **95%完了**
- **選手基本情報**: 100%完了 (名前、登録番号、級別、期別、支部、性別)
- **詳細成績データ**: 100%完了 (1着率、2連対率、3連対率の全期間)
- **ST関連データ**: 100%完了 (平均ST、ST順位、ST考察)
- **フロントエンド**: 100%完了 (React TypeScript + CSS)

#### 🚧 **フェーズ2: 統計データ追加** - **20%完了**
- **決まり手データ**: 0%（未実装）
- **枠別勝率**: 100%完了
- **レース基本情報**: 0%（未実装）

#### ❌ **フェーズ3: 高度なデータ取得** - **0%完了**
- **モーター関連データ**: 0%（未実装）
- **展示・試走データ**: 0%（未実装）
- **オッズ情報**: 0%（未実装）

### 🎉 **主な成果**
1. **完全なデータ構造体実装**: RustとTypeScriptで型安全
2. **包括的UI実装**: カード形式表示、レスポンシブデザイン
3. **テスト駆動開発**: 20250705データでの検証済み
4. **品質保証**: 全テスト合格、ビルド成功

### 🎯 **次のマイルストーン**
1. **決まり手データ実装** (フェーズ2完了に向けて)
2. **レース基本情報追加** (メタデータ拡張)
3. **AJAX取得機能準備** (フェーズ3準備)

---

作成日：2025-07-05  
更新日：2025-07-06（テーブル構造問題の解決）  
最終更新：2025-07-10（フェーズ1完了、進捗サマリー追加）