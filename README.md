# 競艇スクレイピングアプリ

競艇の出走情報をスクレイピングするTauriアプリケーションです。フロントエンドにReact + TypeScript、バックエンドにRustを使用しています。

## 現在の機能

### 📊 データ取得機能
- **競艇日和サイト**からレース統計データを取得
- 指定した日付・レース番号・競艇場の情報を自動取得
- HTMLファイルの自動保存（`bort-html/`ディレクトリ）
- **データキャッシュ機能**: 取得済みデータの効率的な再利用
- **一括取得機能**: 複数レースのデータを一括で取得
- **プログレスバー表示**: データ取得進捗のリアルタイム表示

### 📈 取得可能なデータ

#### 選手基本情報（1号艇のみ）
- 選手名、登録番号、級別、期別、支部、性別

#### 統計データ
- **逃げ率・逃がし率**: 1年間・半年間
- **差され率・捲られ率**: 1年間・半年間
- **直近成績**: 直近10レースでの1着回数

#### 詳細成績データ
- **1着率・2連対率・3連対率**: 今期、直近6ヶ月/3ヶ月/1ヶ月、当地、一般戦別

#### ST関連データ
- **平均ST・ST順位**: 今期、直近6ヶ月/3ヶ月、当地、一般戦、ナイター別
- **ST考察**: 安定率、抜出率、出遅率

#### 決まり手データ（直近6ヶ月）
- **1号艇**: 逃げ率、差され率、捲られ率
- **2号艇以降**: 差し率、逃し率

#### オッズデータ
- **単勝・複勝オッズ**: 艇番別

> **注意**: 三連単オッズ機能は実装していません。データの安定性に課題があるため、単勝・複勝オッズのみに集中する方針です。

### 🖥️ ユーザーインターフェース
- 日付選択
- レース番号選択（1〜12レース）
- 競艇場選択（全24場対応）
- リアルタイム結果表示
- 統計データの見やすい表形式表示
- プログレスバーによる取得状況の可視化

## 技術スタック

### フロントエンド
- **React + TypeScript**: UIコンポーネント
- **Tauri API**: Rustバックエンドとの通信
- **Vite**: バンドラー

### バックエンド（Rust）
- **headless_chrome**: ブラウザ自動化とスクレイピング
- **scraper**: HTMLパースとDOM操作
- **Tauri**: アプリケーションフレームワーク
- **serde**: データシリアライゼーション

## 開発コマンド

### フロントエンド
```bash
pnpm dev              # 開発サーバーの起動
pnpm build           # プロダクションビルド（TypeScriptコンパイル + Viteビルド）
pnpm preview         # プロダクションビルドのプレビュー
```

### Tauriアプリケーション
```bash
pnpm tauri dev       # Tauriアプリケーション開発モード
pnpm tauri build     # アプリケーションのビルド
```

### テスト（Rust）

**基本コマンド:**
```bash
cargo test           # 全テスト実行（時間がかかる）
cargo test --lib     # ライブラリテストのみ実行
```

**高速テスト（開発時推奨、~1秒）:**
```bash
cargo test tests::test_get_biyori_info_invalid          # パラメータ検証テスト
cargo test tests::test_get_win_place_odds_info_invalid  # オッズ検証テスト
cargo test tests::test_get_bulk_race_data_invalid       # 一括取得エラーテスト
cargo test parse::biyori::flame::tests                  # HTMLパース機能テスト
```

**実データテスト（5~30秒、スクレイピング実行）:**
```bash
cargo test tests::test_get_biyori_info_valid             # 実データ取得テスト（~10秒）
cargo test tests::test_get_win_place_odds_info_valid     # 実オッズ取得テスト（~8秒）
cargo test tests::test_get_bulk_race_data_valid          # 実一括取得テスト（~15秒）
cargo test headress::tests                               # スクレイピング実行テスト（~15秒）
```

**推奨ワークフロー:**
```bash
# 1. 開発中の高速チェック（~1秒）
cargo test tests::test_get_biyori_info_invalid

# 2. リリース前の完全テスト（~1分）
cargo test --lib

# 3. HTML/スクレイピング確認（~10秒）
cargo test headress::tests::test_fetch_win_place_odds_from_kyoteibiyori -- --nocapture
```

### デプロイ

**タグによる自動デプロイ:**
```bash
# バージョンタグをプッシュすると自動的にGitHub Releasesでビルド・公開されます
git tag v1.0.0
git push origin v1.0.0
```

タグのプッシュにより、以下のプラットフォーム向けのビルドが自動実行されます：
- **Windows**: `.exe` および `.msi` インストーラー
- **macOS (Intel)**: `x86_64-apple-darwin` バイナリ
- **macOS (Apple Silicon)**: `aarch64-apple-darwin` バイナリ
- **Linux**: `AppImage` および `.deb` パッケージ

> **注意**: タグは `v*` 形式（例: `v1.0.0`, `v2.1.3`）である必要があります。

## アーキテクチャ

### バックエンド構成（Rust）
- **lib.rs**: Tauriコマンドの定義とメインアプリケーション
- **headress.rs**: headless_chromeを使用したスクレイピング機能
- **database.rs**: データキャッシュ管理（取得済みデータの保存・再利用）
- **fetcher.rs**: HTTP リクエスト処理
- **parse/**: サイト別のHTMLパース機能
  - `biyori/flame.rs`: 競艇日和サイトのレースデータ解析
  - `official.rs`: 公式サイト用パーサー

### フロントエンド構成
- **React + TypeScript**: UIコンポーネント
- **Tauri API**: Rustバックエンドとの通信
- **Vite**: バンドラー
- **hooks/**: カスタムフック（`useActiveRaces`, `useBulkData`, `useOddsData`）
- **components/**: UIコンポーネント（`ActiveRacesTable`, `OddsDataContainer`）

### データフロー
1. フロントエンドから日付・レース番号・競艇場番号を送信
2. Rustバックエンドがキャッシュを確認（ヒットすればキャッシュを返却）
3. キャッシュミス時はheadless_chromeでサイトアクセス
4. HTMLを取得・パース
5. 統計データを構造化してキャッシュに保存
6. フロントエンドに返却し、プログレスバー更新

## 現在の制限事項・未実装機能

### データの制限
- **1号艇のみの情報**: 全6艇中1号艇の選手情報のみ（2〜6号艇のデータ取得不可）
- **限定的な統計期間**: 直近10レースの1着回数のみ（より詳細な成績履歴・月別年別推移等は未対応）

### オッズ機能の制約
- **限定的なオッズタイプ**: 単勝・複勝のみ（二連単・二連複・拡連複・三連単等は未対応）
  - 三連単オッズは意図的に未実装（データの不安定性のため）
- **オッズ分析機能なし**: 期待値計算・回収率シミュレーション・人気と実績の乖離分析等

### レース情報の不足
- **レース条件情報なし**: 天候・風速・水面状況・進入コース予想・モーター/ボート情報
- **過去レース結果なし**: 同条件での過去成績・対戦相手との相性・会場別成績詳細

### UI・UX機能
- **データ保存・比較機能の限定**: お気に入り選手登録・複数レースの比較表示等は未対応
  - ✅ キャッシュ機能により取得済みデータは再利用可能
- **リアルタイム機能なし**: オッズ変動追跡・レース結果自動取得・通知機能

### システム機能
- **自動スクレイピングなし**: 日程全体の自動データ収集・スケジュール実行等は未対応
  - ✅ 複数レース一括取得機能は実装済み
  - ✅ データキャッシュ機能は実装済み
- **エラー処理・復旧機能の不足**: ネットワークエラー時の再試行・データ取得失敗時のフォールバック

## 将来の拡張予定

- 全艇番（2〜6号艇）の選手情報対応
- 他の賭け式（二連単・二連複・拡連複）への対応
  - ※ 三連単オッズは実装予定なし（データの不安定性のため）
- レース条件情報（天候・水面状況等）の取得
- データ永続化・比較機能の強化
- オッズ分析・期待値計算機能
- 自動スクレイピング・スケジュール実行機能
- リアルタイムオッズ変動追跡
- エラーハンドリングの改善（再試行・フォールバック機能）

### 実装済み
- ✅ データキャッシュ機能
- ✅ 複数レース一括取得機能
- ✅ プログレスバー表示

## 開発環境セットアップ

### 推奨IDE
- [VS Code](https://code.visualstudio.com/) + [Tauri](https://marketplace.visualstudio.com/items?itemName=tauri-apps.tauri-vscode) + [rust-analyzer](https://marketplace.visualstudio.com/items?itemName=rust-lang.rust-analyzer)

### 必要な依存関係
- Node.js (pnpm使用)
- Rust
- Chrome/Chromium（headless_chrome用）
